{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "The infrastructure for hosting place a votes front end.",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": ["dev", "beta", "prod"],
      "Description": "Specifies which environment to create/update"
    }
  },
  "Mappings": {
    "BucketName": {
      "dev": { "bucket": "dev.placeavote.com" },
      "beta": { "bucket": "beta.placeavote.com" },
      "prod": { "bucket" : "www.placeavote.com" }
    }
  },
  "Resources": {

    "Site": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy" : "Retain",
      "Properties": {
        "AccessControl": "PublicRead",
        "BucketName": { "Fn::FindInMap" : [ "BucketName", { "Ref" : "Environment" }, "bucket"]},

        "WebsiteConfiguration": {
          "IndexDocument": "index.html"
        }
      }
    },

    "CDN": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Aliases": [{ "Fn::FindInMap" : [ "BucketName", { "Ref" : "Environment" }, "bucket"]}],
          "Origins": [
            {
              "S3OriginConfig": {
                "OriginAccessIdentity": ""
              },
              "Id": {"Fn::GetAtt": ["Site", "WebsiteURL"]},
              "DomainName": {"Fn::GetAtt": ["Site", "DomainName"]}
            }
          ],
          "DefaultCacheBehavior": {
            "ForwardedValues": {
              "QueryString": true
            },
            "TargetOriginId": {"Fn::GetAtt": ["Site", "WebsiteURL"]},
            "ViewerProtocolPolicy": "allow-all"
          },
          "DefaultRootObject": "index.html",
          "Enabled": true
        }
      }
    },

    "Route": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "AliasTarget": {
          "DNSName": {"Fn::GetAtt": ["CDN", "DomainName"]},
          "HostedZoneId": "Z2FDTNDATAQYW2"
        },
        "HostedZoneId": "ZHFDR302GM09A",
        "Name": { "Fn::FindInMap" : [ "BucketName", { "Ref" : "Environment" }, "bucket"]},
        "Type": "A"
      }
    }
  }
}
